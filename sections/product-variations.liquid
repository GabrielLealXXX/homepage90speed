{% comment %}
  FIX: Otimização de Imagens Responsivas
  Resolve: "Improve image delivery" do Lighthouse
  Economia: ~177 KiB por página
{% endcomment %}

{%- liquid
  assign collection = collections[section.settings.collection]
  
  if collection != blank and collection.products.size > 0
    assign products = collection.products
  else
    assign products = collections.all.products
  endif
  
  assign total = products.size
-%}

{%- style -%}
#fc{{section.id}}{--bg:{{section.settings.badge_bg_color}};--tx:{{section.settings.badge_text_color}};padding:clamp(24px,5vw,60px) 0}
.fc-c{max-width:1400px;margin:0 auto;padding:0 16px}
.fc-h{text-align:center;margin-bottom:clamp(20px,4vw,40px)}
.fc-t{font-size:clamp(24px,4vw,36px);font-weight:700;margin:0 0 8px;line-height:1.2}
.fc-st{font-size:clamp(14px,2vw,16px);color:#666;margin:0}
.fc-w{position:relative}
.fc-cr{display:flex;gap:16px;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:8px}
.fc-cr::-webkit-scrollbar{display:none}
.fc-card{flex:0 0 calc(85vw - 32px);max-width:340px;scroll-snap-align:start;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08)}
@media(min-width:640px){.fc-card{flex-basis:calc(45vw - 32px);max-width:320px}}
@media(min-width:1024px){.fc-card{flex-basis:calc(25vw - 32px);max-width:300px;transition:transform .2s}.fc-card:hover{transform:translateY(-4px)}.fc-card:hover .fc-img{transform:scale(1.05);transition:transform .3s}}
.fc-img-w{position:relative;aspect-ratio:3/4;background:#f5f5f5;overflow:hidden}
.fc-img{width:100%;height:100%;object-fit:cover}
.fc-bdg{position:absolute;top:12px;left:12px;padding:6px 12px;background:var(--bg);color:var(--tx);font-size:12px;font-weight:600;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;backdrop-filter:blur(8px);z-index:2}
.fc-info{padding:16px}
.fc-rat{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:14px}
.fc-stars{display:flex;gap:2px;align-items:center}
.fc-star{width:18px;height:18px;position:relative;display:flex;align-items:center;justify-content:center}
.fc-star:before{content:'★';color:#FFD700;font-size:18px;line-height:1}
.fc-star.e:before{color:#e0e0e0;font-size:18px}
.fc-star.h:before{background:linear-gradient(90deg,#FFD700 50%,#e0e0e0 50%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:18px}
.fc-rat-a{font-weight:600;color:#333}
.fc-rat-c{color:#666;font-size:13px}
.fc-ttl{font-size:16px;font-weight:600;margin:0 0 8px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.fc-ttl a{color:inherit;text-decoration:none}
.fc-pr{display:flex;align-items:baseline;gap:8px;font-weight:700;font-size:18px}
.fc-pr-c{font-size:14px;color:#999;text-decoration:line-through;font-weight:400}
.fc-cols{display:flex;gap:8px;margin-top:12px}
.fc-col{width:24px;height:24px;border-radius:50%;border:2px solid #e0e0e0}
@media(min-width:1024px){.fc-col{cursor:pointer;transition:transform .2s,border-color .2s}.fc-col:hover{transform:scale(1.1);border-color:#333}}
.fc-nav{display:none}
@media(min-width:768px){.fc-nav{display:flex;justify-content:center;gap:12px;margin-top:24px}}
.fc-btn{width:44px;height:44px;border-radius:50%;background:#fff;border:1px solid #e0e0e0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.fc-btn:hover:not(:disabled){background:#f5f5f5;border-color:#333}
.fc-btn:disabled{opacity:.3;cursor:not-allowed}
.fc-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.fc-dots{display:flex;justify-content:center;gap:8px;margin-top:20px}
@media(min-width:768px){.fc-dots{display:none}}
.fc-dot{width:8px;height:8px;border-radius:50%;background:#d0d0d0;transition:all .3s;border:0;padding:0;cursor:pointer}
.fc-dot.active{width:24px;border-radius:4px;background:#333}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
{%- endstyle -%}

<div id="fc{{section.id}}">
  <div class="fc-c">
    {% if section.settings.title != blank or section.settings.subtitle != blank %}
    <div class="fc-h">
      {%if section.settings.title!=blank%}<h2 class="fc-t">{{section.settings.title}}</h2>{%endif%}
      {%if section.settings.subtitle!=blank%}<p class="fc-st">{{section.settings.subtitle}}</p>{%endif%}
    </div>
    {%endif%}

    <div class="fc-w">
      <div class="fc-cr" id="cr{{section.id}}">
        {%for product in products%}
        <div class="fc-card">
          <div class="fc-img-w">
            {%if section.settings.show_badge and section.settings.badge_text!=blank%}
            <span class="fc-bdg">{{section.settings.badge_text}}</span>
            {%endif%}
            <a href="{{product.url}}" aria-label="{{product.title}}">
              {%if product.featured_image%}
              {%liquid
                if forloop.first
                  assign ld='eager'
                  assign fp='high'
                else
                  assign ld='lazy'
                  assign fp='auto'
                endif
              %}
              <img 
                class="fc-img" 
                src="{{product.featured_image|image_url:width:340}}" 
                srcset="{{product.featured_image|image_url:width:340}} 340w,
                        {{product.featured_image|image_url:width:450}} 450w"
                sizes="(min-width: 1024px) 300px, (min-width: 640px) 320px, 340px"
                alt="{{product.featured_image.alt|default:product.title|escape}}" 
                loading="{{ld}}" 
                fetchpriority="{{fp}}" 
                width="340" 
                height="453" 
                decoding="async">
              {%else%}
              {{'product-1'|placeholder_svg_tag:'fc-img'}}
              {%endif%}
            </a>
          </div>
          <div class="fc-info">
            {%if section.settings.show_rating%}
            {%liquid
              assign r=product.metafields.custom.media_das_avaliacoes|default:0
              assign rc=product.metafields.custom.total_de_avaliacoes|default:0
              assign rf=r|floor
              assign rd=r|minus:rf|times:10
              assign hh=false
              assign hp=rf|plus:1
              if rd>=3
                assign hh=true
              endif
            %}
            {%if rc>0%}
            <div class="fc-rat">
              <div class="fc-stars" aria-label="Avaliação {{r}} de 5">
                {%for i in(1..5)%}
                <span class="fc-star{%if i>rf%}{%if i==hp and hh%} h{%else%} e{%endif%}{%endif%}"></span>
                {%endfor%}
              </div>
              <span class="fc-rat-a">{{r}}</span>
              <span class="fc-rat-c">({{rc}})</span>
            </div>
            {%endif%}
            {%endif%}
            <h3 class="fc-ttl"><a href="{{product.url}}">{{product.title}}</a></h3>
            <div class="fc-pr">
              <span>{{product.price|money}}</span>
              {%if product.compare_at_price>product.price%}
              <span class="fc-pr-c">{{product.compare_at_price|money}}</span>
              {%endif%}
            </div>
            {%if section.settings.show_colors and product.variants.size>1%}
            <div class="fc-cols">
              {%assign cc=0%}
              {%for v in product.variants%}
              {%if cc<4 and v.featured_image%}
              <div class="fc-col" style="background:url('{{v.featured_image|image_url:width:50}}') center/cover" aria-label="{{v.title}}"></div>
              {%assign cc=cc|plus:1%}
              {%endif%}
              {%endfor%}
            </div>
            {%endif%}
          </div>
        </div>
        {%endfor%}
      </div>

      <div class="fc-nav">
        <button class="fc-btn" onclick="fcNav('{{section.id}}',-1)" aria-label="Anterior">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button class="fc-btn" onclick="fcNav('{{section.id}}',1)" aria-label="Próximo">
          <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>

      <div class="fc-dots" id="dt{{section.id}}"></div>
    </div>
  </div>
</div>

<script>
window.fcNav=window.fcNav||function(id,dir){const c=document.getElementById('cr'+id);if(!c)return;const w=c.children[0].offsetWidth+16;c.scrollBy({left:dir*w,behavior:'smooth'})};
window.fcInit=window.fcInit||function(id,t){const c=document.getElementById('cr'+id),d=document.getElementById('dt'+id);if(!c||!d||d.children.length)return;const f=document.createDocumentFragment();for(let i=0;i<t;i++){const b=document.createElement('button');b.className='fc-dot'+(i?'':' active');b.onclick=()=>{c.scrollTo({left:c.children[i].offsetLeft,behavior:'smooth'})};f.appendChild(b)}d.appendChild(f);let s;c.onscroll=()=>{clearTimeout(s);s=setTimeout(()=>{const p=c.scrollLeft/(c.scrollWidth-c.clientWidth),x=Math.round(p*(t-1));[...d.children].forEach((e,i)=>e.classList.toggle('active',i===x))},100)}};
fcInit('{{section.id}}',{{total}});
</script>

{% schema %}
{
  "name": "Produtos em Destaque",
  "tag": "section",
  "class": "section-featured-products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Produtos em Destaque"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Descubra nossa coleção exclusiva"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Coleção"
    },
    {
      "type": "header",
      "content": "Badge Personalizado"
    },
    {
      "type": "checkbox",
      "id": "show_badge",
      "label": "Mostrar badge",
      "default": true
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Texto do badge",
      "default": "Esquenta Black Friday"
    },
    {
      "type": "color",
      "id": "badge_bg_color",
      "label": "Cor de fundo do badge",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Cor do texto do badge",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Opções"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Mostrar avaliações (metafields)",
      "default": true,
      "info": "Usa os metafields: custom.media_das_avaliacoes e custom.total_de_avaliacoes"
    },
    {
      "type": "checkbox",
      "id": "show_colors",
      "label": "Mostrar variantes de cor",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Carrossel de Produtos",
      "category": "Produtos"
    }
  ]
}
{% endschema %}